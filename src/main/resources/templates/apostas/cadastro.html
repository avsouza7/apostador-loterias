<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>Apostador de Loterias - Cadastro de apostas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<div th:replace="fragmentos/fragmentos :: cabecalho"></div>
<div class="container mt-4">

<div class="container mt-4">
    <h2 th:text="${aposta.idAposta != null ? 'Editar Aposta' : 'Nova Aposta'}"></h2>

    <form th:action="@{/apostas/salvar}" th:object="${aposta}" method="post">
        <input type="hidden" th:field="*{idAposta}"/>
			<div class="row">
				<div class="form-group col-md-2">
					<div class="alert alert-danger" role="alert" th:if="${#fields.hasErrors('idLoteria')}">
						<label th:errors="*{idLoteria}" class="validation-message"></label>
					</div>
					<select class="form-control" th:field="*{idLoteria}">
		  				<option th:each="loteriasEnum : ${T(br.com.avsouza7.enuns.LoteriaEnum).values()}" 
		  						th:value="${loteriasEnum.idLoteria}" 
		  						th:text="${loteriasEnum.nome}">
		  				</option>
					</select>
				</div>
				<div class="form-group col-md-2">
					<div class="alert alert-danger" role="alert" th:if="${#fields.hasErrors('idGrupo')}">
						<label th:errors="*{idGrupo}" class="validation-message"></label>
					</div>
					<select class="form-control" th:field="*{idGrupo}">
		  				<option th:each="grupoEnum : ${T(br.com.avsouza7.enuns.GrupoEnum).values()}" 
		  						th:value="${grupoEnum.idGrupo}" 
		  						th:text="${grupoEnum.nmGrupo}">
		  				</option>
					</select>
				</div>
				<div class="form-group col-md-2">
					<div class="alert alert-danger" role="alert" th:if="${#fields.hasErrors('idConcurso')}">
						<label th:errors="*{idConcurso}" class="validation-message"></label>
					</div>
					<label>Código do Concurso</label> 
					<input type="number" class="form-control" th:field="*{idConcurso}">
				</div>				
			</div>
			
			<div class="form-group col-md-6">
				<label>Sorteio</label>
				<input type="date" class="form-control" th:field="*{dtSorteio}">
			</div>		
			
			<div class="d-flex align-items-start gap-2">
		    <table id="tabelaDezenas">
			    <thead>
			        <tr>
			            <th>Dezenas</th>
			            <th></th>
			        </tr>
			    </thead>		    
		        <tbody>
			        <tr th:each="dezena, stat : *{dezenas}">
			            <td>
			                <input type="text" th:field="*{dezenas[__${stat.index}__]}"/>
			            </td>
			        </tr>
		        </tbody>
		    </table>
			<button type="button" onclick="adicionarLinha()" class="btn btn-secondary">Adicionar linha</button>
			</div>
			
			<table id="tabelaApostadores">
			    <thead>
			        <tr>
			            <th>Nome</th>
			            <th>Aporte</th>
			            <th></th>
			        </tr>
			    </thead>
			
			    <tbody>
			        <tr th:each="apostador, stat : *{apostadores}">
			            <input type="hidden" th:field="*{apostadores[__${stat.index}__].idPessoa}"/>
			            <td>
			                <input type="text" th:field="*{apostadores[__${stat.index}__].nome}" readonly />
			            </td>
			            <td>
			                <input type="number" th:field="*{apostadores[__${stat.index}__].aporte}" />
			            </td>
			            <td>
			                <button type="button" onclick="removerLinha(this)" class="btn btn-danger btn-sm">
			                    Remover
			                </button>
			            </td>
			        </tr>
			    </tbody>
			</table>
			
			
        <div class="mt-3">
	        <button type="submit" class="btn btn-success">Salvar</button>
	        <a th:href="@{/apostas/listar}" class="btn btn-secondary">Cancelar</a>
		</div>
    </form>
</div>

<script>
function adicionarLinha() {
    const tabela = document.getElementById("tabelaDezenas").querySelector("tbody");
    const index = tabela.rows.length;

    const tr = document.createElement("tr");
    tr.innerHTML = `
        <td>
            <input type="text" name="dezenas[${index}]"/>
        </td>`;
    
    tabela.appendChild(tr);
}
function removerLinha(botao) {
    const linha = botao.closest("tr");
    linha.remove();
    reindexar();
}

function reindexar() {
    const linhas = document.querySelectorAll("#tabelaApostadores tbody tr");

    linhas.forEach((tr, index) => {
        tr.querySelectorAll("input").forEach(input => {
            const name = input.getAttribute("name");
            if (name) {
                // troca o índice antigo pelo novo
                input.setAttribute(
                    "name",
                    name.replace(/\apostadores\[\d+\]/, `apostadores[${index}]`)
                );
            }
        });
    });
}
</script>
</body>
</html>

